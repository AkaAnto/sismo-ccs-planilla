
<link rel="stylesheet" type="text/css" href="http://127.0.0.1:8080/geoserver/openlayers/theme/default/style.css"/>
<!-- Basic CSS definitions -->
<style type="text/css">
        /* General settings */
    body {
        font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
        font-size: small;
    }
        /* Toolbar styles */
    #toolbar {
        position: relative;
        padding-bottom: 0.5em;
        display: none;
    }

    #toolbar ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #toolbar ul li {
        float: left;
        padding-right: 1em;
        padding-bottom: 0.5em;
    }

    #toolbar ul li a {
        font-weight: bold;
        font-size: smaller;
        vertical-align: middle;
        color: black;
        text-decoration: none;
    }

    #toolbar ul li a:hover {
        text-decoration: underline;
    }

    #toolbar ul li * {
        vertical-align: middle;
    }

        /* The map and the location bar */
    #map {
        clear: both;
        position: relative;
        width: 512px;
        height: 412px;
        border: 1px solid black;
    }

    #wrapper {
        width: 512px;
    }

    #location {
        float: right;
    }

    #options {
        position: absolute;
        left: 13px;
        top: 7px;
        z-index: 3000;
    }

        /* Styles used by the default GetFeatureInfo output, added to make IE happy */
    table.featureInfo, table.featureInfo td, table.featureInfo th {
        border: 1px solid #ddd;
        border-collapse: collapse;
        margin: 0;
        padding: 0;
        font-size: 90%;
        padding: .2em .1em;
    }

    table.featureInfo th {
        padding: .2em .2em;
        font-weight: bold;
        background: #eee;
    }

    table.featureInfo td {
        background: #fff;
    }

    table.featureInfo tr.odd td {
        background: #eee;
    }

    table.featureInfo caption {
        text-align: left;
        font-size: 100%;
        font-weight: bold;
        padding: .2em .2em;
    }
</style>
<!-- Import OpenLayers, reduced, wms read only version -->
<script src="{{STATIC_URL}}js/jquery-1.8.2.min.js" type="text/javascript">
<script src="{{STATIC_URL}}js/openlayer.js" type="text/javascript">

</script>

<script  type="text/javascript">



    $(document).ready(function(){
        var map, layer, control;
        var poligonos_funvisis;
        var select ;
        var open_street;

        //*****************settings*****************//
        //OpenLayers.ProxyHost= "proxy.cgi?url=";
        format = 'image/gif';
        var bounds = new OpenLayers.Bounds(
                -66.9101945258253, 10.4995727922997,
                -66.8906349949867, 10.5153133026893
        );
        var options = {
            controls: [

            ],
            maxExtent: bounds,
            maxResolution: 0.0000764044173383,
            projection: "EPSG:4326",
            units: 'degrees'
        };


        //*****************settings*****************//

        //*****************map*****************//
        map = new OpenLayers.Map('map', options);
        //*****************map*****************//

        //*****************Protocols*****************//


/*

        var protocol = new OpenLayers.Protocol.WFS({
            version: "1.1.0",
            url:  "http://127.0.0.1:8080/geoserver/wfs/",
            featureType: "inspeccion_poligono",
            featureNS: "htttp://127.0.0.1:8080/geoserver/funvisis/"
            //srsName: "EPSG:4326"

        });
*/



        //*****************Protocols*****************//

        //*****************Layers*****************//
        select = new OpenLayers.Layer.Vector("Poligonos Wfs");



        osm = new OpenLayers.Layer.OSM( "Simple OSM Map");
        layer = new OpenLayers.Layer.WMS(
                "funvisis:inspeccion_poligono", "http://127.0.0.1:8080/geoserver/funvisis/wms",
                {
                    LAYERS: 'funvisis:inspeccion_poligono',
                    STYLES: '',
                    format: format,
                    tiled: true,
                    tilesOrigin : map.maxExtent.left + ',' + map.maxExtent.bottom,
                    transparent:true
                },
                {
                    buffer: 0,
                    displayOutsideMaxExtent: true,
                    isBaseLayer: false,
                    yx : {'EPSG:4326' : true}
                }
        );
      /* var candelaria = new OpenLayers.Layer.Vector("Candelaria edificios", {
            strategies: [new OpenLayers.Strategy.Fixed()],
            protocol: protocol});

*/
        //*****************Layers*****************//

        //*****************Adding Layers To Map*****************//
        map.addLayers([osm,layer]);
//        map.addLayer(layer);
        map.addLayer(select);





        //*****************Adding Layers To Map*****************//

        var features;



        //select.addFeatures(features);


        //*****************Controls*****************//
       /* get_feature_control = new OpenLayers.Control.GetFeature({
            protocol: protocol,
            box: false,
            click: true

        });*/
        layer_switcher_control = new OpenLayers.Control.LayerSwitcher();
        zoom_control = new OpenLayers.Control.PanZoomBar({ position: new OpenLayers.Pixel(15, 15) });
        navigation_control = new OpenLayers.Control.Navigation();
        mouse_position_control = new OpenLayers.Control.MousePosition();
        overview_control = new OpenLayers.Control.OverviewMap();
        keyboard_control = new OpenLayers.Control.KeyboardDefaults();

        //*****************Controls*****************//

        //*****************Events*****************//
        /*get_feature_control.events.register("featureselected", this, function(e) {
            alert(e.feature);
        });*/





        function setHTML(response){


             parse = response.responseText;
            console.log(parse);
            geojson_format = new OpenLayers.Format.GeoJSON();
            features = geojson_format.read(parse,null,null);
            map.layers[2].removeAllFeatures();
            map.layers[2].addFeatures(features);
            map.layers[2].drawFeature(features);
            map.layers[2].refresh();


           /*  url ="http://127.0.0.1:8080/geoserver/wfs?service=wfs&version=1.1.0&request=GetFeature&typeName=funvisis:inspeccion_poligono&outputFormat=json&FeatureId=500";

             $.get(url,function(data){


                 console.log(data);

                 geojson_format = new OpenLayers.Format.GeoJSON();


                 features = geojson_format.read(data,null,null);

                 console.log(features);


                 map.layers[2].removeAllFeatures();
                 map.layers[2].addFeatures(features);
                 map.layers[2].drawFeature(features);
                 map.layers[2].refresh();



                 console.log(select);


             });*/


        }




       map.events.register('click', map.layers[1], function (e) {
            //document.getElementById('nodelist').innerHTML = "Loading... please wait...";
            var params = {
                REQUEST: "GetFeatureInfo",
                EXCEPTIONS: "application/vnd.ogc.se_xml",
                BBOX: map.getExtent().toBBOX(),
                SERVICE: "WMS",
                INFO_FORMAT: 'application/json',
                QUERY_LAYERS: map.layers[1].params.LAYERS,
                FEATURE_COUNT: 50,
                Layers: 'funvisis:inspeccion_poligono',
                WIDTH: map.size.w,
                HEIGHT: map.size.h,
                format: format,
                styles: map.layers[0].params.STYLES,
                srs: map.layers[1].params.SRS};

            // handle the wms 1.3 vs wms 1.1 madness
            if(map.layers[0].params.VERSION == "1.3.0") {
                params.version = "1.3.0";
                params.j = parseInt(e.xy.x);
                params.i = parseInt(e.xy.y);
            } else {
                params.version = "1.1.1";
                params.x = parseInt(e.xy.x);
                params.y = parseInt(e.xy.y);
            }

            // merge filters
            if(map.layers[0].params.CQL_FILTER != null) {
                params.cql_filter = map.layers[0].params.CQL_FILTER;
            }
            if(map.layers[0].params.FILTER != null) {
                params.filter = map.layers[0].params.FILTER;
            }
            if(map.layers[0].params.FEATUREID) {
                params.featureid = map.layers[0].params.FEATUREID;
            }


           OpenLayers.loadURL("http://127.0.0.1:8080/geoserver/funvisis/wms", params, this, setHTML,setHTML);

           OpenLayers.Event.stop(e);

        });
        // sets the HTML provided into the nodelist element





            //*****************Events*****************//

        //*****************Adding Contrls To Map*****************//
        map.addControl(layer_switcher_control);
        map.addControl(zoom_control);
        map.addControl(navigation_control);
        map.addControl(mouse_position_control);
        map.addControl(overview_control);
        map.addControl(keyboard_control);
        //*****************Adding Contrls To Map*****************//
        //get_feature_control.activate();
        map.setCenter(
                new OpenLayers.LonLat(-66.9101945258253, 10.4995727922997).transform(
                        new OpenLayers.Projection("EPSG:4326"),
                        map.getProjectionObject()
                ), 16
        );


    });





</script>
        <div align="center">


            <div id="nodelist">
                <em>Click on the map to get feature info</em>
            </div>

        </div>
        <br/>
<div id="map">

</div>